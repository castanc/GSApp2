<script>
    let dt = new Date();
    let recType = "";
    let cache = new KVPCollection();
    let Data = new KVPCollection();
    let logLevel = 0;
    let logs = [];
    let record = {};
    let records = [];
    let requiredFields = "";
    let response;
    let confirming = false;
    let htmlRecType = "";
    let formChanged = false;
    let master;
    let detail;
    let days = "Todos,Dom,Lun,Mar,Mie,Jue,Vie,Sab,Dom".split(",");
    let months = "Todos,Ene,Feb,Mar,Abr,May,Jun,Jul,Ago,Sep,Oct,Nov,Dic".split(",");
    let recTypes = "";
    let filterRT = "";
    let filterMes = "";
    let filterDia = "";
    let master2;
    let fecha = "";
    let year = 2021;
    let desde = 1;
    let hasta = 31;
    let editMode = false;
    let glucLevelsText = `0,59,"blueviolet";60,89,"green";90,99,"yellow";100,119,"red";120,139,"slateblue";140,159,"navy";160,179,"darkmagenta";180,999,"darkblue"`;
    let glucLevels = [0, 0, 0, 0, 0, 0, 0, 0, 0];
    let minG = 0;
    let maxG = 999;
    let sortDescending = false;






    function addLog(title, text, method = "", obj = "", show = false, level = 0) {
        let lm = new LogMessage();
        lm.text = text;
        lm.obj = obj;
        lm.title = title;
        if (method != null && method.length > 0) {
            if (method.indexOf("()" < 0))
                method = `${method}()`;
            logs = [];
            LogMessage.method = method;
        }

        logs.push(lm);
        if (show)
            log(level);
    }


    //todo: add remvoed items to food items combo
    function removeItem(title, id) {
        records = records.filter(x => x.id != id);
        for (var i = 0; i < records.length; i++) {
            records[i].id = i;
        }
        renderFoodItems();
    }

    function removeDrug(title, id) {
        records = records.filter(x => x.id != id);
        for (var i = 0; i < records.length; i++) {
            records[i].id = i;
        }
        renderDrugItems();
    }

    function removeExe(title, id) {
        records = records.filter(x => x.id != id);
        for (var i = 0; i < records.length; i++) {
            records[i].id = i;
        }
        renderExeItems();
    }

    function replace(text, value, newValue) {
        try {
            while (text.indexOf(value) >= 0)
                text = text.replace(value, newValue);
        }
        catch (ex) {
        }
        return text;
    }

    function log(level) {

        if (level == logLevel || level == 9999) {

            let row = "";
            let json = "";
            for (var i = 0; i < logs.length; i++) {
                row = `${row}
                 <tr><td>${LogMessage.method}</td><td>${logs[i].title}</td><td>${logs[i].text}</td></tr>
                `;
                console.log(LogMessage.method, logs[i].text);
                console.log(logs[i].obj);
            }
            let table = `<table>${row}</table>`;
            writeInnerHtml("result", table);
            sessionStorage.setItem("lastLog", JSON.stringify(logs));
        }



    }

    function setRecord(i, value) {
        if (i < records.length) {
            records[i].cant = Number(value);
        }
    }

    function setTime(i, value) {
        if (i < records.length) {
            records[i].time = value;
        }

    }

    function calcDivision(id, value) {

    }

    function renderFoodItems() {
        let row = "";
        if (records.length > 0) {

            row = `<div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-2"></div>
            <div class="col-md-3">Cant</div>
            <div class="col-md-1">Un</div>
            <div class="col-md-4">Food Item</div>
            </div>
            `;

            for (var i = 0; i < records.length; i++) {
                row = `${row}
            <div class="row">
                <div class="col-md-2">
                    <img src="${records[i].url}" class="thumb"></img>
                    </div>
                <div class="col-md-2 cursorPointer"><i class="fas fa-trash-alt"  onclick="removeItem('${DrugItems}',${i})"></i></div>
                <div class="col-md-3">
                    <input type="number" id="q{${i}} name="q${i}" placeholder="Cant" value="${records[i].cant}" onchange="setRecord(${i},this.value)">
                </div>
                <div class="col-md-1">
                    ${records[i].unit}
                </div>
                <div class="col-md-4">${records[i].descr}</div>

            </div>`;
            }
        }
        writeInnerHtml("rows", row);

    }


    function getIcon(recType) {
        let icon = "";
        if (recType == "FOOD") icon = "fa fa-utensils";
        else if (recType == "DRUG") icon = "fa fa-medkit";
        else if (recType == "EXE") icon = "fas fa-swimmer";
        else if (recType == "PRS") icon = "fa fa-stethoscope";
        else if (recType == "WEIGHT") icon = "fas fa-weight";
        else if (recType == "GLUC") icon = "fa fa-heart";
        else if (recType == "EVENT") icon = "calendar-plus";
        return icon;
    }

    function getColor(recType) {
        let color = "";
        if (recType == "FOOD") color = "brown";
        else if (recType == "DRUG") color = "fa fa-medkit";
        else if (recType == "EXE") color = "darkgreen";
        else if (recType == "PRS") color = "darkmagenta";
        else if (recType == "WEIGHT") color = "deepskyblue";
        else if (recType == "GLUC") color = "darkred";
        else if (recType == "EVENT") color = "blue";
        return color;
    }

    function getHtmlFromArray(name, caption = "", list, required = false) {
        let onChange = "";
        let requiredText = "";

        if (required)
            requiredText = "required";

        name = name.trim();

        if (caption.length == 0)
            caption = "None";

        var options = "";   //`< option selected > ${caption} < /option>`;
        for (var i = 0; i < list.length; i++) {
            options = options + `<option value="${i}">${list[i]}</option>`;
        }
        onChange = `onChange="onChange_${name}('${name}',this.options[this.selectedIndex].value)"`;
        return `<select id="SELECTID" name="SELECTID" ${onChange} ${required}>${options}</select>`;

    }

    function geSimpleHtmlFromArray(name, caption = "", list, required = false) {
        let onChange = "";
        let requiredText = "";

        if (required)
            requiredText = "required";

        name = name.trim();

        if (caption.length == 0)
            caption = "None";

        var options = "";   //`< option selected > ${caption} < /option>`;
        for (var i = 0; i < list.length; i++) {
            options = options + `<option value="${list[i]}}">${list[i]}</option>`;
        }
        onChange = `onChange="onChange_${name}('${name}',this.options[this.selectedIndex].value)"`;
        return `<select id="SELECTID" name="SELECTID" ${onChange} ${required}>${options}</select>`;

    }

    //https://stackoverflow.com/questions/16096872/how-to-sort-2-dimensional-array-by-column-value

    function sortFunction(a, b) {
        if (a[3] === b[3]) {
            return 0;
        }
        else {
            if (sortDescending)
                return (a[3] > b[3]) ? -1 : 1;
            else
                return (a[3] < b[3]) ? -1 : 1;
        }
    }

    function buildRecords0(recType, id, defValue = "") {
        result = defValue;
        //let arr = master.filter(x=>x[1]==id);
        // detail.foreach(item => {
        //     if ( item[1]==id)
        //         arr.push(item);
        // })

        if (recType == "FOOD") {
            let mt = Items.arr.filter(x => x[0] = "MT" && x[1] == defValue);
            if (mt.lenght > 0)
                result = `${mt[2].substr(0, 4)}:`
            //console.log("mealType:",mt,result);
        }

        let arr = detail.filter(x => x[1] == id);
        let ri;
        if (arr.length > 0) {

            if (recType == "FOOD") {
                for (var i = 0; i < arr.length; i++) {
                    ri = FoodItems.arr.filter(x => x[1] == arr[i][3])
                    if (ri.lenght > 0) {
                        result = `${result} ${ri[0]},`;
                    }
                }
            }
            else if (recType == "DRUG") {
                for (var i = 0; i < arr.length; i++) {
                    ri = DrugItems.arr.filter(x => x[1] == arr[i][1])
                    if (ri.lenght > 0) {
                        result = `${result} ${ri[1].toUpperCase().substr(0, 2)},`;
                    }
                }
            }
            else if (recType == "EXE") {

                for (var i = 0; i < arr.length; i++) {
                    ri = ExeItems.arr.filter(x => x[1] == arr[i][1])
                    if (ri.lenght > 0) {
                        result = `${result} ${ri[1]} ${ri[4]} ${ri[5]},`;
                    }
                }
            }
            if (ri.length > 0) {
                console.log("*********************************************************");
                console.log("buildRecords()", recType, id, defValue, "arr:", arr, arr.length);
                console.log("ri", recType, id, "ri:", ri, "result:", result);
            }
        }
        return result;
    }


    function buildRecords(recType, id, defValue = "") {
        if (",FOOD,EXE,DRUG,".indexOf(recType) < 0)
            return defValue;

        result = defValue;
        let ri;
        if (recType == "FOOD") {
            let mt = Items.arr.filter(x => x[0] = "MT" && x[1] == defValue);
            if (mt.length > 0) {
                result = `${mt[0][2]}:`
            }
        }

        let arr = detail.filter(x => x[1] == id);
        arr.forEach(item => {
            if (recType == "FOOD") {
                ri = FoodItems.arr.filter(x => x[1] == item[3])
                ri.forEach(detail => {
                    result = `${result} ${detail[0]},`;
                })

            }
            else if (recType == "DRUG") {
                ri = DrugItems.arr.filter(x => x[0] == item[3])
                ri.forEach(detail => {
                    result = `${result} ${detail[1].toUpperCase()},`;
                })

            }
            else if (recType == "EXE") {
                ri = ExeItems.arr.filter(x => x[0] == item[3])
                ri.forEach(detail => {
                    result = `${result} ${detail[1]} ${item[4]} ${item[5]},`;
                })

            }
        })
        return result;
    }

    function sortArray(arr, col, desc = true) {
        return arr.sort(sortFunction);

    }


    function sumGluc(level) {
        let sum = 0;
        for (var i = 0; i <= level; i++) {
            sum += glucLevels[i];
        }
        return sum;
    }

    function closeedit() {
        editMode = false;
        clearDiv("content");
        master = [[]];
        detail = [[]];
        newRecord();
    }


    function getTotals(glucCount) {
        let html = "";
        let row = "";
        let percLine = "";
        let sumLine = "";
        let countLine = "";
        let seg = glucLevelsText.split(";");

        if (glucCount > 0) {
            seg.forEach(item => {
                let l = item.split(",");
                row = `${row}<div class="col-md-1" style="background-color:${l[2]}">${l[0]}-${l[1]}</div>`;
            })
            row = `<div class="col-md-2></div>${row}<div class="col-md-2></div>`;

            for (var i = 0; i < seg.lenght; i++) {
                countLine = `${countLine}<div class="col-md-1">${glucLevels(i)}</div>`;
            }
            countLine = `<div class="col-md-2>${countLine}<div class="col-md-2>`;

            for (var i = 0; i < seg.lenght; i++) {
                let p1 = glucTotals[i] / glucCount;
                p1 = p1 * 100;
                let p = p1.split(".");
                let p2 = "";
                if (p.length > 0) {
                    p2 = p[0];
                }
                else p2 = p1;

                if (p2.length > 3)
                    p2 = p2.substr(0, 3);
                p2 = `${p2}%`
                percLine = `${percLine}<div class="col-md-1">${p2}</div>`
                sumLine = `${sumLine}<div class="col-md-1">${sumGluc(i)}</div>`
            }
            percLine = `<div class="col-md-2>${percLine}<div class="col-md-2>`;
            sumLine = `<div class="col-md-2>${sumLine}<div class="col-md-2>`;
        }

        html = `
        <div class="row">
            <div class="col-md-12">
                <p class="text-info text-center">${glucCount} Mediciones Glucogeno</p>
            </div>
        </div>
        <div class="row">
            ${row}
        </div>
        <div class="row">
            ${countLine}
        </div>
        <div class="row">
            ${percLine}
        </div>
        <div class="row">
            ${sumLine}
        </div>`;

        console.log("row", row);
        console.log("coutnLine", countLine);
        console.log("percLine", percLine);
        console.log("sumLine".sumLine);

        console.log("totals", html);
        localStorage.setItem("row", row);
        localStorage.setItem("coutnLine", countLine);
        localStorage.setItem("percLine", percLine);
        localStorage.setItem("sumLine", sumLine);
        localStorage.setItem("totales", html);
        return html;
    }

    function buildGlucRange() {
        let glucRange = `<div class="row">
    <div class="col-md-6 big-font">
        Glucose Min:
    </div>
    <div class="col-md-6 big-font">
        <input type="number" id="GLUC_MIN" name="GLUC_MIN" class="form-control"></input>
    </div>
</div>
<div class="row">
    <div class="col-md-6 big-font">
        Glucose Max:
    </div>
    <div class="col-md-6 big-font">
        <input type="number" id="GLUC_MAX" name="GLUC_MAX" class="form-control"></input>
    </div>
</div>
`;

        writeInnerHtml("GLUC_RANGE", glucRange);

    }
    
    function renderMaster() {
        let recType = "";
        let classText = "";
        glucLevels = [0, 0, 0, 0, 0, 0, 0, 0];
        let countGluc = 0;
        let icon = "";
        let iconColor = "";

        if (master.lenght < 1)
            return;

        showDiv("content");

        let row = `
            <hr>
            <div class="row">
            <div class="col-md-1"></div>
            <div class="col-md-1">Dia</div>
            <div class="col-md-2">Fecha</div>
            <div class="col-md-2">Hora</div>
            <div class="col-md-6">Data</div>
            </div>
            `;

        if (master.length > 0) {

            let master2;
            if (filterRT != "") {
                master2 = master.filter(x => x[9] = filterRT);
                master2 = sortArray(master2, 3);
            }
            else
                master2 = sortArray(master, 3);

            buildGlucRange();
            let styleTag = "";
         

            GlucLevels.forEach(item=>{
                item.count = 0;
                item.acumulado =0;
            })

            let divRecords = "";
            for (var i = 0; i < master2.length; i++) {
                recType = master[i][9].trim();

                let rti = RecTypes.filter(x => x.name == recType);
                icon = "";
                iconColor = "";
                styleTag = "";

                if (rti.length > 0) {
                    icon = rti[0].icon;
                    iconColor = `color:${rti[0].textColor};`;
                    styleTag = `style="${iconColor}"`;
                }

                if (icon == "")
                    continue;


                let iconTag = `<span style="font-size: 40px; ${iconColor}"><i class="${icon}"></i></span>`;

                divRecords = buildRecords(recType, master2[i][1], master2[i][12]);

                let value = master2[i][12];
                if (recType == "GLUC") {
                    countGluc++;
                    let gl = GlucLevels.filter(x => value >= x.min && value < x.max);
                    if (gl.length > 0) {
                        styleTag = `style="background-color:${gl[0].backgroundColor};"`;
                        gl.count++;
                        console.log("styleTag",styleTag);
                        console.log("glucose level:",gl);
                    }
                }

                row = `${row}
            <div class="row row-fat">
                <div class="col-md-1">
                    ${iconTag}
                </div>
                <div class="col-md-1">
                    ${days[master2[i][8] + 1]} 
                </div>
                <div class="col-md-2">
                  ${months[master2[i][6]]}-${master2[i][7]}
                </div>
                <div class="col-md-2">
                  ${master2[i][11]}
                </div>
                <div id="data${master2[i][1]}" class="col-md-6" ${styleTag}>
                    ${divRecords}
                </div>
            </div>`;
            }
        }
        let glucTotals = `
        <div class="row"><hr></div>
        <div class="row">
    <div class="col-md-12">
        <p class="text-info text-center">
            ${countGluc} Mediciones de Glucogeno
        </p>
    </div>
</div>
<div class="row">
    <div class="col-md-2">
    </div>
    <div class="col-md-1" style="background-color:blueviolet; color:white;">
        60
    </div>
    <div class="col-md-1" style="background-color:forestgreen; color:white;">
        90
    </div>
    <div class="col-md-1" style="background-color:green; color:white;">
        100
    </div>
    <div class="col-md-1" style="background-color:yellow; color:white;">
        120
    </div>
    <div class="col-md-1" style="background-color:red; color:white;">
        140
    </div>
    <div class="col-md-1" style="background-color:slateblue; color:white;">
        160
    </div>
    <div class="col-md-1" style="background-color:navy; color:white;">
        180
    </div>
    <div class="col-md-1" style="background-color:darkmagenta; color:white;">
        >180
    </div>
    <div class="col-md-2">
    </div>

</div>
<div class="row">
    <div class="col-md-2">
    </div>
    <div class="col-md-1">
        ${glucLevels[0]}
    </div>
    <div class="col-md-1">
        ${glucLevels[1]}
    </div>
    <div class="col-md-1">
        ${glucLevels[2]}
    </div>
    <div class="col-md-1">
        ${glucLevels[3]}
    </div>
    <div class="col-md-1">
        ${glucLevels[4]}
    </div>
    <div class="col-md-1">
        ${glucLevels[5]}
    </div>
    <div class="col-md-1">
        ${glucLevels[6]}
    </div>
    <div class="col-md-1">
        ${glucLevels[7]}
    </div>
    <div class="col-md-2">
    </div>`;
        //writeInnerHtml("result",glucTotals);
        row = `${row}`;
        //let totals2 = getTotals(glucTotals);

        writeInnerHtml("title", glucTotals);

        writeInnerHtml("content", row);

    }

    function renderDrugItems(div = "rows") {

        let row = "";
        if (records.length > 0) {

            row = `<div class="row row-fat">
                <div class="col-md-1"></div>
            <div class="col-md-1"></div>
            <div class="col-md-8">Drug Item</div>
            <div class="col-md-2">Cant</div>
            </div>
            `;

            for (var i = 0; i < records.length; i++) {
                row = `${row}
            <div class="row row-fat">
                <div class="col-md-1">
                    <img src="${records[i].url}" class="thumb"></img>
                    </div>
                <div class="col-md-1 cursorPointer"><i class="fas fa-trash-alt"  onclick="removeDrug('${DrugItems}',${i})"></i></div>
                <div class="col-md-8" >${records[i].descr}</div>
                <div class="col-md-2">
                    <input type="number" id="q{${i}} name="q${i}" placeholder="Cant" value="${records[i].cant}" onchange="setRecord(${i},this.value)">
                </div>
            </div>`;
            }
        }
        writeInnerHtml(div, row);
    }


    function renderExeItems(div = "rows") {
        let row = "";
        if (records.length > 0) {

            row = `<div class="row row-fat">
            <div class="col-md-1"></div>
            <div class="col-md-1"></div>
            <div class="col-md-4">Sport</div>
            <div class="col-md-1">Dist</div>
            <div class="col-md-1">Un</div>
            <div class="col-md-2">Time</div>
            </div>
            `;

            for (var i = 0; i < records.length; i++) {
                row = `${row}
            <div class="row row-fat">
                <div class="col-md-1"></div>
                <div class="col-md-1 cursorPointer"><i class="fas fa-trash-alt"  onclick="removeExe('${DrugItems}',${i})"></i></div>
                <div class="col-md-4">${records[i].descr}</div>
                <div class="col-md-1">
                    <input type="number" id="q{${i}} name="q${i}" placeholder="Dist" value="${records[i].cant}" onchange="setRecord(${i},this.value)">
                </div>
                <div class="col-md-2">
                    ${records[i].unit}
                </div>
                <div class="col-md-3">
                    <input type="number" id="h{${i}} name="t${i}" placeholder="HH:MM:SS" pattern="^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$" value="${records[i].time}" onchange="setRecordTime(${i},this.value)">
                </div>
            </div>`;
            }
        }
        writeInnerHtml(div, row);
    }


    function renderRecords(title) {
        let row = `<div class="row">
            <div class="col-2">Remove</div>
            <div class="col-5">${title}</div>
            <div class="col-2">Cant</div>
            <div class="col-2">Unidades</div>
            <div class="col-1">Image</div>
            </div>`;

        for (var i = 0; i < records.length; i++) {
            row = `${row}
            <div class="row">
            <div class="col-2"><btn type="button" class ="btn tbn-danger">Remove</button></div>
            <div class="col-5">${records[i].descr}</div>
            <div class="col-2"><input type="number" id="q{${i}} name="q${i}" placeholder="Cant" value = "${records[i].cant}" class="form-control"></div>
            <div class="col-2">${records[i].unit}</div>
            <div class="col-1"><img src="${records[i].url}" class="rounded img-fluid"></img></div>
            </div>            
            `;
        }
        writeInnerHtml("rows", row);
    }


    function getSelect(name, arr, idCol = 0, valueCol = 1, title = "", selectedValue = "", req = false, startRow = 0) {
        let options = "";
        let required = "";
        let onChange = `onchange="onchange_${name}(this.options[this.selectedIndex].value)"`;

        if (title.length == 0)
            title = "Select...";

        if (req)
            required = "required";

        options = `<option value="">${title}</option>`
        for (var i = startRow; i < arr.length; i++) {
            if (selectedValue != "" && arr[i][idCol] == selectedValue)
                options = `${options}<option value="${arr[i][idCol]}" selected>${arr[i][valueCol]}</option>`
            else
                options = `${options}<option value="${arr[i][idCol]}">${arr[i][valueCol]}</option>`
        }

        let html = `<select name="SELECT_${name}" id="SELECT_${name}" ${required} ${onChange} class="form-control big-font fat-row">
        ${options}</select>`

        return html;

    }

    function getHtmlSelectFiltered(arr, groupId, title = "", value = "", controlId = "", required = false, startRow = 0) {
        arr = arr.filter(x => x[0] == groupId);
        let html = "";
        if (controlId.length > 0)
            html = this.getSelect(controlId, arr, 1, 2, title, value, required);
        else
            html = this.getSelect(groupId, arr, 1, 2, title, value, required);

        return html;
    }

    function initializeData(colList) {
        let c = colList.split(',');
        Data = new KVPCollection();
        for (var i = 0; i < c.length; i++) {
            Data.add(c[i], "");
        }
    }

    function initializeFormRecType() {
        records = [];
        if (recType == "FOOD") {
            renderFoodItems();
            requiredFields = "REC_TYPE,FECHA,HORA,MEAL_TYPES";
            initializeData(requiredFields);
            htmlSelect = getHtmlSelectFiltered(Items.arr, "MT", "Selecione Tipo de Comida", true);
            writeInnerHtml("MEAL_TYPES", htmlSelect);

            htmlSelect = getHtmlSelectFiltered(Items.arr, "FC", "Seleccione Categoria");
            writeInnerHtml("FOOD_CATEGORIES", htmlSelect);
        }
        else if (recType == "EXE") {
            requiredFields = "REC_TYPE,FECHA,HORA";
            initializeData(requiredFields);
            htmlSelect = getSelect("ExeItems", ExeItems.arr, 0, 1, "Select Deporte", "", true, 1);
            writeInnerHtml("EXE_ITEMS", htmlSelect);
        }
        else if (recType == "DRUG") {
            requiredFields = "REC_TYPE,FECHA,HORA,DRUGID,CANT";
            initializeData(requiredFields);
            Data.update("REC_TYPE", recType);
            htmLSelect = getSelect("DrugItems", DrugItems.arr, 0, 1, "Select Droga", "", true, 1);
            writeInnerHtml("DRUG_ITEMS", htmLSelect);
        }
        else if (recType == "PRS") {
            requiredFields = "REC_TYPE,FECHA,HORA,SISTOLIC,DIASTOLIC,PULSE,PULSEOF";
            initializeData(requiredFields);
        }
        else if (recType == "WEIGHT") {
            requiredFields = "REC_TYPE,FECHA,HORA,PESO,FAT,BMI";
            initializeData(requiredFields);
        }
        else if (recType == "EVENT") {
            requiredFields = "REC_TYPE,FECHA,HORA,EVENTID,DETAILS";
            initializeData(requiredFields);

        }
        else if (recType == "GLUC") {
            requiredFields = "REC_TYPE,FECHA,HORA,URL";
            initializeData(requiredFields);
        }
        else if (recType == "LEG") {
            requiredFields = "REC_TYPE,FECHA,HORA,URL";
            initializeData(requiredFields);
        }

    }

    function processData(recType, data) {
        console.log(`processData() ${recType}`)
        console.log("data:", data);
        initializeFormRecType();
        Data.update("REC_TYPE", recType);

        if (response.showModal) {
            writeInnerHtml("modalBody", response.messages);
            showDiv("modalPopUp");
        }

    }

    function addFoodItem(itemId) {
        record.itemId = itemId;
        record.id = records.length;
        records.push(record);
        let row = `<tr><td>Food Item</td><td>Cant</td><td>Image</td></tr>`;
        for (var i = 0; i < records.length; i++) {
            row = `${row}
      <tr><td>Food Item</td><td>Cant</td><td>Image</td></tr>`;
        }
    }


    function onBlurField(id, value) {
        console.log(`onBlurField() ${id} ${value}`);
        Data.update(id, value);

    }

    function processResponSubmitForm(json) {
        let msg = "Respuesta recibida del servidor.";
        hideDiv("spinner");
        showMessage(msg);
        response = JSON.parse(json);
        console.log("Response received from Server. processResponSubmitForm():", response);
        if (response.result == 200) {
            for (var i = 0; i < response.html.length; i++) {
                writeInnerHtml(response.html[i].key, response.html[i].value)
            }

            msg = "";
            for (var i = 0; i < response.messages.lenght; i++) {
                msg = `${msg}<p class="text-info>${response.messages[i]}</p></br>`;
            }
            //writeInnerHtml("result", msg);
            if (msg == "" && response.messages.lenght > 0) {
                msg = response.messages[0];
            }
            console.log("messaage received:", msg);
            showMessage(msg);
            newRecord();
        }
        else {
            let row = `<tr><td>Server Error</td><td>${response.result}</td></tr>`;
            for (var i = 0; i < response.error.length; i++) {
                row = `${row}<tr><td>${response.error[i].key}</td><td>${response.error[i].value}</td></tr>`;
            }

            let table = `<table>${row}</table>`;
            writeInnerHtml("error", table);
        }
    }

    function changeButtonText(btn, text) {
        let changed = false;
        let currentText = document.querySelector(`#${btn}`).innerHTML;
        if (currentText.toLowerCase().indexOf(text.toLowerCase()) < 0) {
            currentText = `${text} ${currentText}`;
            document.querySelector(`#${btn}`).innerHTML = currentText;
            changed = true;
        }
        return changed;
    }


    function processForm() {
        console.log("processForm()");
        if (!confirming) {
            //changeButtonText("submitMenu","Confirm ");
            writeInnerHtml("btnSubmit", "Confirmar");
            confirming = true;
            return;
        }
        else {
            writeInnerHtml("btnSubmit", "Guardar");
            confirming = false;
        }
        if (document.forms["myForm"].checkValidity()) {
            disableButtons(true);
            showDiv("spinner");
            showMessage("Enviando datos al Servidor...");
            hideDiv("content");
            hideDiv("rows");
            showDiv("DIVfechaHora");
            showDiv("DIVrecType");



            Data.update("FECHA", getValue("FECHA"));
            Data.update("HORA", getValue("HORA"));
            Data.update("REC_TYPE", recType);

            console.log("processForm()");
            console.log(Data);
            let recordsBase = [];
            for (var i = 0; i < records.length; i++) {
                let r = new RecordItemBase();
                r.itemId = records[i].itemId;
                if (recType == "FOOD" || recType == "DRUG")
                    r.cant = records[i].cant;
                else if (recType == "EXE") {
                    r.cant = records[i].cant;
                    r.time = records[i].time;
                }

                recordsBase.push(r);
            }


            console.log("Data", Data);
            newRecord();

            google.script.run.withFailureHandler(failureHandler)
                .withSuccessHandler(processResponSubmitForm)
                .processForm(Data, recordsBase);
        }
        else {

            showError("Some fields are required");

        }

    }


    function processResponseEdit(json) {
        response = JSON.parse(json);

        console.log("Response received from Server. processResponseEdit():", response);
        if (response.result == 200) {
            for (var i = 0; i < response.html.length; i++) {
                writeInnerHtml(response.html[i].key, response.html[i].value)
                localStorage.setItem(`${response.html[i].key}_${recType}`, response.html[i].value);
            }

            let msg = "";
            for (var i = 0; i < response.messages.lenght; i++) {
                msg = `${msg}<p class="text-info>${response.messages[i]}</p></br>`;
            }
            writeInnerHtml("result", msg);
            //todo: show only if form modified
            showDiv("submitArea");
            master = response.master;
            detail = response.detail;
            renderMaster();
        }
        else {
            let row = `<tr><td>Server Error</td><td>${response.result}</td></tr>`;
            for (var i = 0; i < response.error.length; i++) {
                row = `${row}<tr><td>${response.error[i].key}</td><td>${response.error[i].value}</td></tr>`;
            }

            let table = `<table>${row}</table>`;
            writeInnerHtml("error", table);
        }
        hideDiv("spinner");
    }



    function edit() {
        editMode = true;
        showDiv("spinner");
        fecha = getValue("FECHA");
        console.log("edit() fecha:", fecha);
        recTypes = getHtmlSelectFiltered(Items.arr, "RT2", "Todos", true);


        dt = getDateFromYMD(fecha);
        google.script.run.withFailureHandler(failureHandler)
            .withSuccessHandler(processResponseEdit)
            .edit(dt.getFullYear());
    }


    function processFoodItemsRequest(json) {
        FoodItems.arr = JSON.parse(json);
    }

    function processExeItemsRequest(json) {
        ExeItems.arr = JSON.parse(json);
        console.log("processExeItemsRequest()")
        console.log("ExeItems", ExeItems);
        let selectExeType = getSelect("ExeItems", ExeItems.arr, 0, 1, "Seleccione Deporte", "", true, 1);
        writeInnerHtml("EXE_ITEMS", selectExeType);
    }


    function processDrugItemsRequest(json) {
        hideDiv("spinner");
        DrugItems.arr = JSON.parse(json);
        let selectDrugType = getSelect("DrugItems", DrugItems.arr, 0, 1, "Seleccione Droga", "", true, 1);
        writeInnerHtml("DRUG_ITEMS", selectDrugType);
    }

    function processRTChange(json) {
        processResponse(json);
    }

    function processResponse(json) {
        response = JSON.parse(json);
        console.log("Response received from Server. processResponse():", response);
        if (response.result == 200) {
            for (var i = 0; i < response.html.length; i++) {
                writeInnerHtml(response.html[i].key, response.html[i].value)
                localStorage.setItem(`${response.html[i].key}_${recType}`, response.html[i].value);
            }

            let msg = "";
            for (var i = 0; i < response.messages.lenght; i++) {
                msg = `${msg}<p class="text-info>${response.messages[i]}</p></br>`;
            }
            writeInnerHtml("result", msg);
            processData(recType, response.data);
            //todo: show only if form modified
            showDiv("submitArea");
        }
        else {
            let row = `<tr><td>Server Error</td><td>${response.result}</td></tr>`;
            for (var i = 0; i < response.error.length; i++) {
                row = `${row}<tr><td>${response.error[i].key}</td><td>${response.error[i].value}</td></tr>`;
            }

            let table = `<table>${row}</table>`;
            writeInnerHtml("error", table);
        }
    }




    function refreshDate() {
        dt = new Date();
        var m = padLeft(dt.getMonth() + 1, 10, '0');
        var d = padLeft(dt.getDate(), 10, '0');
        var fecha = `${dt.getFullYear()}-${m}-${d}`;
        var h = padLeft(dt.getHours(), 10, '0');
        var mi = padLeft(dt.getMinutes(), 10, '0');
        var hora = `${h}:${mi}`;

        var dti = document.getElementById('FECHA');
        dti.value = fecha;

        dti = document.getElementById('HORA');
        dti.value = hora;
    }


    function cancelSubmit() {
        console.log("cancelSubmit()");
        newRecord();
    }

    function newRecord() {
        console.log("newRecord");
        clearDiv("GLUC_RANGE");
        editMode = false;
        writeInnerHtml("title", "PrecKee. Personal Record Keeper");
        formChanged = false;
        confirming = false;
        refreshDate();

        writeInnerHtml("REC_TYPE", htmlRecType);
        showDiv("DIVfechaHora");
        showDiv("DIVrecType");
        clearDiv("content");
        clearDiv("rows");
        hideDiv("submitArea");
        records = [];
        recType = "";

        disableButtons(false);
        console.log("newRecord END");
    }

    function initialize() {
        showMessage("© 2021 Cesar Castaño");
        showDiv("spinner");
        console.log("initialize");
        htmlRecType = getHtmlSelectFiltered(Items.arr, "RT", "Seleccione Registro", true);
        newRecord();
        showMessage("Ready");
        console.log("items", Items.arr);



        setTimeout(function () {
            // This hides the address bar:
            window.scrollTo(0, 1);
        }, 0);

        if (FoodItems.arr.length == 0) {
            google.script.run.withFailureHandler(failureHandler).withSuccessHandler(getFoodItemsHandler)
                .getFoodItems();
        }
        if (ExeItems.arr.length == 0) {
            google.script.run.withFailureHandler(failureHandler).withSuccessHandler(processExeItemsRequest)
                .getExeItems();
        }
        if (DrugItems.arr.length == 0) {
            google.script.run.withFailureHandler(failureHandler).withSuccessHandler(getDrugItemsHandler)
                .getDrugItems();
        }
    }


    //************************************ event handlers ***********************************
    function failureHandler(error) {
        hideDiv("spinner");
        writeInnerHtml("error", error);
    }

    function getFoodItemsHandler(json) {
        processFoodItemsRequest(json);

    }

    function getDrugItemsHandler(json) {
        processDrugItemsRequest(json);

    }

    function successHandler(json) {
        localStorage.setItem("json", json);
        processResponse(json);
    }




    function clearRows() {
        records = [];
        clearDiv("rows");
        showDiv("rows");
    }

    function onchange_SP(e) {
        Data.update("SPORTID", e);
    }

    function onchange_RT(e) {
        console.log("onchange_RT", e);
        // if ( editMode )
        // {
        //     filterRT = e;
        //     renderMaster();
        //     return;
        // }
        if (e == "")
            return;



        Data.update("REC_TYPE", e);
        clearDiv("result");
        clearDiv("error");
        hideDiv("DIVfechaHora");
        hideDiv("DIVrecType")
        showDiv("content");
        clearRows();



        recType = e;
        let html = "";
        let = url = "";
        records = [];
        writeInnerHtml("rows", "");

        html = localStorage.getItem(`content_${recType}`);
        console.log("html from local storage", html);
        if (html == undefined)
            html = "";

        if (html.length == 0) {
            console.log("getting form from server");
            let row = Items.arr.filter(x => x[0] == "RT" && x[1] == recType);
            if (row.length > 0)
                url = row[3];

            google.script.run.withFailureHandler(failureHandler).withSuccessHandler(processResponse)
                .getForm("RT", recType, url);
        }
        else {
            writeInnerHtml("content", html);
            initializeFormRecType();
            showDiv("submitArea");
        }

    }

    function onchange_MT(e) {
        Data.update("MEAL_TYPES", e);
    }


    function onchange_EV(e) {
        Data.update("EVENTID", e);
    }

    function onchange_FC(e) {
        foodCategory = e;
        let selectFoodItems = getHtmlSelectFiltered(FoodItems.arr, foodCategory, "Seleccione Alimento", "", "FoodItems");
        writeInnerHtml("FOOD_ITEMS", selectFoodItems);
    }



    function onchange_DrugItems(e) {
        Data.update("DRUGID", e);
        let di = DrugItems.arr.filter(x => x[0] == e);
        if (di.length > 0) {
            formChanged = true;
            record = {};    // new RecordItem();
            record.descr = di[0][1];
            record.url = di[0][4];
            record.unit = di[0][3];
            record.cant = di[0][2];
            record.divisor = "";
            record.itemId = Number(e);
            record.id = records.length;
            records.push(record);
            renderDrugItems();
        }

    }


    function onchange_ExeItems(e) {
        Data.update("SPORTID", e);
        let di = ExeItems.arr.filter(x => x[0] == e);
        if (di.length > 0) {
            formChanged = true;
            record = {};    // new RecordItem();
            record.descr = di[0][1];
            record.url = "";
            record.unit = di[0][4];
            record.cant = di[0][3];
            record.itemId = Number(e);
            record.id = records.length;
            record.time = "";
            records.push(record);
            renderExeItems();
        }

    }



    //todo: remove assigned items from combo
    function onchange_FoodItems(e) {
        console.log("onchange_FoodItems");
        let fi = FoodItems.arr.filter(x => x[1] == e);
        if (fi.length > 0) {
            formChanged = true;
            record = {};    // new RecordItem();
            record.descr = fi[0][2];
            record.url = fi[0][9];
            record.unit = fi[0][4];
            record.cant = fi[0][3];
            record.divisor = "";
            record.itemId = Number(e);
            record.id = records.length;
            records.push(record);
            renderFoodItems();
        }
    }




    function onSuccess(html) {
        refreshDate();

        var div = document.getElementById("formDiv");
        div.innerHTML = html;


        var select = document.getElementById("SELECT_REC_TYPE");
        try {
            if (select.options.length > 0)
                loadContent(select.options[0].value)
        }
        catch (ex) {
            console.log("exceptioon selecting first item", ex);
        }
    }

    //************************************ event handlers end ***********************************



    //Main entry point
    console.log("js_index onLoad")
    window.addEventListener('load', initialize);

</script>
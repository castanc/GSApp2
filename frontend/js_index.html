<script>
    let dt = new Date();
    let recType = "";
    let cache = new KVPCollection();
    let Data = new KVPCollection();
    let logLevel = 0;
    let logs = [];
    let record = {};
    let records = [];
    let requiredFields = "";
    let response;
    let confirming = false;
    let htmlRecType = "";



    function addLog(title, text, method = "", obj = "", show = false, level = 0) {
        let lm = new LogMessage();
        lm.text = text;
        lm.obj = obj;
        lm.title = title;
        if (method != null && method.length > 0) {
            if (method.indexOf("()" < 0))
                method = `${method}()`;
            logs = [];
            LogMessage.method = method;
        }

        logs.push(lm);
        if (show)
            log(level);
    }


    //todo: add remvoed items to food items combo
    function removeItem(title, id) {
        records = records.filter(x => x.id != id);
        for (var i = 0; i < records.length; i++) {
            records[i].id = i;
        }
        renderFoodItems();
    }

    function removeDrug(title, id) {
        records = records.filter(x => x.id != id);
        for (var i = 0; i < records.length; i++) {
            records[i].id = i;
        }
        renderDrugItems();
    }

    function removeExe(title, id) {
        records = records.filter(x => x.id != id);
        for (var i = 0; i < records.length; i++) {
            records[i].id = i;
        }
        renderExeItems();
    }

    function replace(text, value, newValue) {
        try {
            while (text.indexOf(value) >= 0)
                text = text.replace(value, newValue);
        }
        catch (ex) {
        }
        return text;
    }

    function log(level) {

        if (level == logLevel || level == 9999) {

            let row = "";
            let json = "";
            for (var i = 0; i < logs.length; i++) {
                row = `${row}
                 <tr><td>${LogMessage.method}</td><td>${logs[i].title}</td><td>${logs[i].text}</td></tr>
                `;
                console.log(LogMessage.method, logs[i].text);
                console.log(logs[i].obj);
            }
            let table = `<table>${row}</table>`;
            writeInnerHtml("result", table);
            sessionStorage.setItem("lastLog", JSON.stringify(logs));
        }



    }

    function setRecord(i, value) {
        if (i < records.length) {
            records[i].cant = Number(value);
        }
    }

    function calcDivision(id, value) {

    }

    function renderFoodItems() {
        let row = "";
        if (records.length > 0) {

            row = `<div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-2"></div>
            <div class="col-md-3">Cant</div>
            <div class="col-md-1">Un</div>
            <div class="col-md-4">Food Item</div>
            </div>
            `;

            for (var i = 0; i < records.length; i++) {
                row = `${row}
            <div class="row">
                <div class="col-md-2">
                    <img src="${records[i].url}" class="thumb"></img>
                    </div>
                <div class="col-md-2 cursorPointer"><i class="fas fa-trash-alt"  onclick="removeItem('${DrugItems}',${i})"></i></div>
                <div class="col-md-3">
                    <input type="number" id="q{${i}} name="q${i}" placeholder="Cant" value="${records[i].cant}" onchange="setRecord(${i},this.value)">
                </div>
                <div class="col-md-1">
                    ${records[i].unit}
                </div>
                <div class="col-md-4">${records[i].descr}</div>

            </div>`;
            }
        }
        writeInnerHtml("rows", row);

    }




    function renderDrugItems() {

        let row = "";
        if (records.length > 0) {

            row = `<div class="row row-fat">
            <div class="col-md-1"></div>
            <div class="col-md-8">Drug Item</div>
            <div class="col-md-2">Cant</div>
            <div class="col-md-1"></div>
            </div>
            `;

            for (var i = 0; i < records.length; i++) {
                row = `${row}
            <div class="row row-fat">
                <div class="col-md-1 cursorPointer"><i class="fas fa-trash-alt"  onclick="removeDrug('${DrugItems}',${i})"></i></div>
                <div class="col-md-8" >${records[i].descr}</div>
                <div class="col-md-2">
                    <input type="number" id="q{${i}} name="q${i}" placeholder="Cant" value="${records[i].cant}" onchange="setRecord(${i},this.value)">
                </div>
                <div class="col-md-1">
                    <img src="${records[i].url}" class="thumb"></img>
                    </div>
            </div>`;
            }
        }
        writeInnerHtml("rows", row);
    }


    function renderExeItems() {
        let row = "";
        if (records.length > 0) {

            row = `<div class="row row-fat">
            <div class="col-md-1"></div>
            <div class="col-md-4">Sport</div>
            <div class="col-md-1">Dist</div>
            <div class="col-md-1">Un</div>
            <div class="col-md-2">Time</div>
            </div>
            `;

            for (var i = 0; i < records.length; i++) {
                row = `${row}
            <div class="row row-fat">
                <div class="col-md-1 cursorPointer"><i class="fas fa-trash-alt"  onclick="removeExe('${DrugItems}',${i})"></i></div>
                <div class="col-md-4">${records[i].descr}</div>
                <div class="col-md-1">
                    <input type="number" id="q{${i}} name="q${i}" placeholder="Dist" value="${records[i].cant}" onchange="setRecord(${i},this.value)">
                </div>
                <div class="col-md-2">
                    ${records[i].unit}
                </div>
                <div class="col-md-3">
                    <input type="number" id="h{${i}} name="t${i}" placeholder="HH:MM:SS" pattern="^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$" value="${records[i].time}" onchange="setRecord(${i},this.value)">
                </div>
            </div>`;
            }
        }
        writeInnerHtml("rows", row);
    }


    function renderRecords(title) {
        let row = `<div class="row">
            <div class="col-2">Remove</div>
            <div class="col-5">${title}</div>
            <div class="col-2">Cant</div>
            <div class="col-2">Unidades</div>
            <div class="col-1">Image</div>
            </div>`;

        for (var i = 0; i < records.length; i++) {
            row = `${row}
            <div class="row">
            <div class="col-2"><btn type="button" class ="btn tbn-danger">Remove</button></div>
            <div class="col-5">${records[i].descr}</div>
            <div class="col-2"><input type="number" id="q{${i}} name="q${i}" placeholder="Cant" value = "${records[i].cant}" class="form-control"></div>
            <div class="col-2">${records[i].unit}</div>
            <div class="col-1"><img src="${records[i].url}" class="rounded img-fluid"></img></div>
            </div>            
            `;
        }
        writeInnerHtml("rows", row);
    }


    function getSelect(name, arr, idCol = 0, valueCol = 1, title = "", selectedValue = "", req = false, startRow = 0) {
        let options = "";
        let required = "";
        let onChange = `onchange="onchange_${name}(this.options[this.selectedIndex].value)"`;

        if (title.length == 0)
            title = "Select...";

        if (req)
            required = "required";

        options = `<option value="">${title}</option>`
        for (var i = startRow; i < arr.length; i++) {
            if (selectedValue != "" && arr[i][idCol] == selectedValue)
                options = `${options}<option value="${arr[i][idCol]}" selected>${arr[i][valueCol]}</option>`
            else
                options = `${options}<option value="${arr[i][idCol]}">${arr[i][valueCol]}</option>`
        }

        let html = `<select name="SELECT_${name}" id="SELECT_${name}" ${required} ${onChange} class="form-control big-font fat-row">
        ${options}</select>`

        return html;

    }

    function getHtmlSelectFiltered(arr, groupId, title = "", value = "", controlId = "", required = false, startRow = 0) {
        arr = arr.filter(x => x[0] == groupId);
        let html = "";
        if (controlId.length > 0)
            html = this.getSelect(controlId, arr, 1, 2, title, value, required);
        else
            html = this.getSelect(groupId, arr, 1, 2, title, value, required);

        return html;
    }

    function initializeData(colList) {
        let c = colList.split(',');
        Data = new KVPCollection();
        for (var i = 0; i < c.length; i++) {
            Data.add(c[i], "");
        }
    }

    function processData(recType, data) {
        records = [];
        let htmlSelect = "";
        if (recType == "FOOD") {
            renderFoodItems();
            requiredFields = "REC_TYPE,FECHA,HORA,MEAL_TYPES";
            initializeData(requiredFields);
            htmlSelect = getHtmlSelectFiltered(Items.arr, "MT", "Select Meal Type", true);
            writeInnerHtml("MEAL_TYPES", htmlSelect);

            htmlSelect = getHtmlSelectFiltered(Items.arr, "FC", "Select Category");
            writeInnerHtml("FOOD_CATEGORIES", htmlSelect);
        }
        else if (recType == "EXE") {
            requiredFields = "REC_TYPE,FECHA,HORA";
            initializeData(requiredFields);
            htmlSelect = getSelect("ExeItems", ExeItems.arr, 0, 1, "Select Sport", "", true, 1);
            writeInnerHtml("EXE_ITEMS", htmlSelect);
        }
        else if (recType == "DRUG") {
            requiredFields = "REC_TYPE,FECHA,HORA,DRUGID,CANT";
            initializeData(requiredFields);
            Data.update("REC_TYPE", recType);
            htmLSelect = getSelect("DrugItems", DrugItems.arr, 0, 1, "Select Drug", "", true, 1);
            writeInnerHtml("DRUG_ITEMS", htmLSelect);
        }
        else if (recType == "PRS") {
            requiredFields = "REC_TYPE,FECHA,HORA,SISTOLIC,DIASTOLIC,PULSE,PULSEOF";
            initializeData(requiredFields);
        }
        else if (recType == "WEIGHT") {
            requiredFields = "REC_TYPE,FECHA,HORA,PESO,FAT,BMI";
            initializeData(requiredFields);
        }
        else if (recType == "EVENT") {
            requiredFields = "REC_TYPE,FECHA,HORA,EVENTID,DETAILS";
            initializeData(requiredFields);

        }
        else if (recType == "GLUC") {
            requiredFields = "REC_TYPE,FECHA,HORA,URL";
            initializeData(requiredFields);
        }
        else if (recType == "LEG") {
            requiredFields = "REC_TYPE,FECHA,HORA,URL";
            initializeData(requiredFields);
        }
        Data.update("REC_TYPE", recType);

        if ( response.showModal )
        {
            writeInnerHtml("modalBody",response.messages);
            showDiv("modalPopUp");
        }

    }

    function addFoodItem(itemId) {
        record.itemId = itemId;
        record.id = records.length;
        records.push(record);
        let row = `<tr><td>Food Item</td><td>Cant</td><td>Image</td></tr>`;
        for (var i = 0; i < records.length; i++) {
            row = `${row}
      <tr><td>Food Item</td><td>Cant</td><td>Image</td></tr>`;
        }
    }


    function onBlurField(id, value) {
        console.log(`onBlurField() ${id} ${value}`);
        Data.update(id, value);
    }


    function changeButtonText(btn, text) {
            let changed = false;
            let currentText = document.querySelector(`#${btn}`).innerHTML;
            if (currentText.toLowerCase().indexOf(text.toLowerCase()) < 0) {
                currentText = `${text} ${currentText}`;
                document.querySelector(`#${btn}`).innerHTML = currentText;
                changed = true;
            }
            return changed;
        }


    function processForm() {
        console.log("processForm()");
        if ( !confirming )
        {
            changeButtonText("btnSubmit","Confirm ");
            confirming = true;
            return;
        }
        else
        {
            confirming = false;
        }
        if (document.forms["myForm"].checkValidity()) {
            disableButtons(true);
            showDiv("mainContent", false);
            showMessage("Sending data for processing...");



            Data.update("FECHA", getValue("FECHA"));
            Data.update("HORA", getValue("HORA"));

            console.log("processForm()");
            console.log(Data);
            let recordsBase = [];
            for (var i = 0; i < records.length; i++) {
                let r = new RecordItemBase();
                r.itemId = records[i].itemId;
                if (recType == "FOOD")
                    r.cant = records[i].cant;

                recordsBase.push(r);
            }


            console.log("Data",Data);
            newRecord();

             google.script.run.withFailureHandler(failureHandler)
                .withSuccessHandler(processResponse)
                .processForm(Data, recordsBase);
        }
        else {
            showError("Some fields are required");

        }

    }
    function processFoodItemsRequest(json) {
        FoodItems.arr = JSON.parse(json);
    }

    function processExeItemsRequest(json) {
        ExeItems.arr = JSON.parse(json);
        console.log("processExeItemsRequest()")
        console.log("ExeItems", ExeItems);
        let selectExeType = getSelect("ExeItems", ExeItems.arr, 0, 1, "Select Sport", "", true, 1);
        writeInnerHtml("EXE_ITEMS", selectExeType);
    }


    function processDrugItemsRequest(json) {
        DrugItems.arr = JSON.parse(json);
        let selectDrugType = getSelect("DrugItems", DrugItems.arr, 0, 1, "Select Drug", "", true, 1);
        writeInnerHtml("DRUG_ITEMS", selectDrugType);
    }

    function processResponse(json) {
        showMessage("Response received from Server");

        response = JSON.parse(json);
        console.log("processResponse()");
        console.log(response);
        if (response.result == 200) {
            for (var i = 0; i < response.html.length; i++) {
                writeInnerHtml(response.html[i].key, response.html[i].value)
            }
            disableButtons(false);
            showDiv("mainContent", true);

            let msg = "";
            for (var i = 0; i < response.messages.lenght; i++) {
                msg = `${msg}<p class="text-info>${response.messages[i]}</p></br>`;
            }
            writeInnerHtml("result", msg);
            processData(recType, response.data);
            showDiv("submitArea",true);
        }
        else {
            let row = `<tr><td>Server Error</td><td>${response.result}</td></tr>`;
            for (var i = 0; i < response.error.length; i++) {
                row = `${row}<tr><td>${response.error[i].key}</td><td>${response.error[i].value}</td></tr>`;
            }

            let table = `<table>${row}</table>`;
            writeInnerHtml("error", table);

        }
    }




    function refreshDate() {
        dt = new Date();
        var m = padLeft(dt.getMonth() + 1, 10, '0');
        var d = padLeft(dt.getDate(), 10, '0');
        var fecha = `${dt.getFullYear()}-${m}-${d}`;
        var h = padLeft(dt.getHours(), 10, '0');
        var mi = padLeft(dt.getMinutes(), 10, '0');
        var hora = `${h}:${mi}`;

        var dti = document.getElementById('FECHA');
        dti.value = fecha;

        dti = document.getElementById('HORA');
        dti.value = hora;
    }


    function newRecord(){
        console.log("newRecord");
        refreshDate();

        //writeInnerHtml("warning-bar-table","");
        writeInnerHtml("REC_TYPE", htmlRecType);
        records = [];
        recType = "";

        writeInnerHtml("rows","");
        disableButtons(false);

        showDiv("common");
        hideDiv("submitArea");
        hideDiv("mainContent");

    }

    function initialize() {

        htmlRecType = getHtmlSelectFiltered(Items.arr, "RT", "Select Record", true);
        newRecord();

        setTimeout(function () {
            // This hides the address bar:
            window.scrollTo(0, 1);
        }, 0);

        if (FoodItems.arr.length == 0) {
            google.script.run.withFailureHandler(failureHandler).withSuccessHandler(getFoodItemsHandler)
                .getFoodItems();
        }
        if (ExeItems.arr.length == 0) {
            google.script.run.withFailureHandler(failureHandler).withSuccessHandler(processExeItemsRequest)
                .getExeItems();
        }
        if (DrugItems.arr.length == 0) {
            google.script.run.withFailureHandler(failureHandler).withSuccessHandler(getDrugItemsHandler)
                .getDrugItems();
        }
    }


    //************************************ event handlers ***********************************
    function failureHandler(error) {
        writeInnerHtml("error", error);
    }

    function getFoodItemsHandler(json) {
        processFoodItemsRequest(json);

    }

    function getDrugItemsHandler(json) {
        processDrugItemsRequest(json);

    }

    function successHandler(json) {
        localStorage.setItem("json", json);
        processResponse(json);
    }





    function onchange_SP(e) {
        Data.update("SPORTID", e);
    }

    function onchange_RT(e) {
        console.log("onchange_RT",e);
        if ( e == "")
            return;

        Data.update("REC_TYPE", e);
        writeInnerHtml("result", "");
        writeInnerHtml("error", "");
        writeInnerHtml("btnSubmit","Submit");


        recType = e;
        let html = "";
        let = url = "";
        records = [];
        writeInnerHtml("rows", "");

        if (html.length == 0) {
            console.log("getting form from server");
            let row = Items.arr.filter(x => x[0] == "RT" && x[1] == recType);
            if (row.length > 0)
                url = row[3];

            google.script.run.withFailureHandler(failureHandler).withSuccessHandler(processResponse)
                .getForm("RT", recType, url);
        }
        else {
            writeInnerHtml("content", html);
        }

    }

    function onchange_MT(e) {
        Data.update("MEAL_TYPES", e);
    }


    function onchange_EV(e) {
        Data.update("EVENTID", e);
    }

    function onchange_FC(e) {
        foodCategory = e;
        let selectFoodItems = getHtmlSelectFiltered(FoodItems.arr, foodCategory, "Select Food Item", "", "FoodItems");
        writeInnerHtml("FOOD_ITEMS", selectFoodItems);
    }


    function onchange_DrugItems(e) {
        Data.update("DRUGID", e);
        let di = DrugItems.arr.filter(x => x[0] == e);
        if (di.length > 0) {
            record = {};    // new RecordItem();
            record.descr = di[0][1];
            record.url = di[0][4];
            record.unit = di[0][3];
            record.cant = di[0][2];
            record.divisor = "";
            record.itemId = Number(e);
            record.id = records.length;
            records.push(record);
            renderDrugItems();
        }

    }


    function onchange_ExeItems(e) {
        Data.update("SPORTID", e);
        let di = ExeItems.arr.filter(x => x[0] == e);
        if (di.length > 0) {
            record = {};    // new RecordItem();
            record.descr = di[0][1];
            record.url = "";
            record.unit = di[0][4];
            record.cant = di[0][3];
            record.itemId = Number(e);
            record.id = records.length;
            record.time = "";
            records.push(record);
            renderExeItems();
        }

    }



    //todo: remove assigned items from combo
    function onchange_FoodItems(e) {
        sessionStorage.setItem("FoodItems", JSON.stringify(FoodItems.arr));
        let fi = FoodItems.arr.filter(x => x[1] == e);
        if (fi.length > 0) {
            record = {};    // new RecordItem();
            record.descr = fi[0][2];
            record.url = fi[0][9];
            record.unit = fi[0][4];
            record.cant = fi[0][3];
            record.divisor = "";
            record.itemId = Number(e);
            record.id = records.length;
            records.push(record);
            renderFoodItems();
        }

    }


  

    function onSuccess(html) {
        showDiv('secondary', false);
        refreshDate();

        var div = document.getElementById("formDiv");
        div.innerHTML = html;


        var select = document.getElementById("SELECT_REC_TYPE");
        try {
            if (select.options.length > 0)
                loadContent(select.options[0].value)
        }
        catch (ex) {
            console.log("exceptioon selecting first item", ex);
        }
    }

    //************************************ event handlers end ***********************************



    //Main entry point
    window.addEventListener('load', initialize);

</script>